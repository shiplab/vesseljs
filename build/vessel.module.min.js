class t{constructor(t,e){null===t?(console.warn("JSONSpecObject: null specification provided. Defaulting to empty specification."),t={}):"object"==typeof t||(void 0!==t&&console.error("JSONSpecObject: Invalid constructor parameter. Defaulting to empty specification."),t={}),e&&(this.baseObjects=e),this.setFromSpecification(t)}setFromSpecification(t){return Object.assign(this,t),this}getSpecification(){let t={};for(k of Object.keys(this))this.hasOwnProperty(k)&&(t[k]=this[k]);return t}toJSON(){return this.getSpecification()}fromJSON(t){return this.setFromSpecification(t)}}function e(t,e){if(e<t[0])return console.warn("bisectionSearch: requested value below lowest array element. Returning undefined."),{index:void 0,mu:void 0};let i=0,s=t.length;for(;s>i+1;){let a=Math.floor(.5*(i+s));if(t[a]===e)return{index:a,mu:0};t[a]<e?i=a:s=a}let a=(e-t[i])/(t[i+1]-t[i]);return i===t.length-1&&(console.warn("bisectionSearch: Reached end of array. Simple interpolation will result in NaN."),a=void 0),{index:i,mu:a}}function i(t,e,i=.5){return isNaN(t)?e:isNaN(e)?t:(1-i)*t+i*e}function s(t,e,i,s,a,o,h,n){let r=e-t,l=s-i;if(0===r||0===l)return[0,0,0,0];let c=1/(r*l);return[c*(a*e*s-h*t*s-o*e*i+n*t*i),c*(-a*s+h*s+o*i-n*i),c*(-a*e+h*t+o*e-n*t),c*(a-h-o+n)]}class a extends t{constructor(t){super(t),this.weightCache={}}setFromSpecification(t){return this.id=t.id,this.affiliations=t.affiliations||{},this.boxDimensions=t.boxDimensions||{length:void 0,width:void 0,height:void 0},this.weightInformation=t.weightInformation,this.cost=t.cost||{currency:void 0,value:void 0},this.capabilities=t.capabilities||{},this.file3D=t.file3D,this.baseState=t.baseState,this}getSpecification(){return{id:this.id,affiliations:this.affiliations,boxDimensions:this.boxDimensions,weightInformation:this.weightInformation,cost:this.cost,capabilities:this.capabilities,file3D:this.file3D,baseState:this.baseState}}getWeight(t){t=t||0;let s,a=this.weightInformation,o=a.contentDensity||0,h=a.volumeCapacity||0,n=a.lightweight+o*h*t;if(void 0!==a.fullnessCGMapping){let o=a.fullnessCGMapping,h=o.fullnesses,n=o.cgs,{index:r,mu:l}=e(h,t);s=[];for(let t=0;t<3;t++){let e;e=r<h.length-1?i(n[r][t],n[r+1][t],l):n[r][t],s.push(e)}}else void 0!==a.cg?s=a.cg:(console.warn("BaseObject.getWeight: No cg or fullnessCGMapping supplied. Defaults to center of bounding box."),s=[0,0,.5*this.boxDimensions.height]);return{mass:n,cg:{x:s[0],y:s[1],z:s[2]}}}}const o={clone:function(t){return{x:t.x,y:t.y,z:t.z}},scale:function(t,e){return{x:e*t.x,y:e*t.y,z:e*t.z}},norm:function(t){return Math.sqrt(t.x**2+t.y**2+t.z**2)},normalize:function(t){let e=norm(t);return{x:t.x/e,y:t.y/e,z:t.z/e}},normSquared:function(t){return t.x**2+t.y**2+t.z**2},add:function(t,e,...i){return i.length>0?o.sum([t,e]+i):{x:t.x+e.x,y:t.y+e.y,z:t.z+e.z}},sum:function(t){let e={x:0,y:0,z:0};for(let i=0;i<t.length;i++){let s=t[i];e.x+=s.x,e.y+=s.y,e.z+=s.z}return e},sub:function(t,e){return{x:t.x-e.x,y:t.y-e.y,z:t.z-e.z}},dot:function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},cross:function(t,e){return{x:t.y*e.z-t.z*e.y,y:t.z*e.x-t.x*e.z,z:t.x*e.y-t.y*e.x}},mulComponents:function(t,e){return{x:t.x*e.x,y:t.y*e.y,z:t.z*e.z}},rotateTaitBryan:function(t,e){let i,s;return i=Math.cos(e.x),s=Math.sin(e.x),t={x:t.x,y:t.y*i-t.z*s,z:t.y*s+t.z*i},i=Math.cos(e.y),s=Math.sin(e.y),t={x:t.z*s+t.x*i,y:t.y,z:t.z*i-t.x*s},i=Math.cos(e.z),s=Math.sin(e.z),t={x:t.x*i-t.y*s,y:t.x*s+t.y*i,z:t.z}}};class h extends t{constructor(t,e){super(t,e)}setFromSpecification(t){return this.id=t.id,this.group=t.group||null,this.affiliations=t.affiliations,"string"==typeof t.baseObject?this.baseObject=this.baseObjects[t.baseObject]:this.baseObject=new a(t.baseObject),this.referenceState=t.referenceState,this.style=t.style||{},this}getSpecification(){let t={id:this.id,group:this.group,affiliations:this.affiliations,referenceState:this.referenceState,style:this.style};return void 0!==this.baseObjects[this.baseObject.id]?t.baseObject=this.baseObject.id:t.baseObject=this.baseObject.getSpecification(),t}getWeight(t){let e=t.getObjectState(this);if(!1===e.exists)return{mass:0,cg:{x:0,y:0,z:0}};let i={x:e.xCentre,y:e.yCentre,z:e.zBase},s=this.baseObject.getWeight(e.fullness),a=s.mass,h=o.add(i,s.cg);return isNaN(h.x+h.y+h.z)&&console.error("DerivedObject.getWeight: returning NaN values."),{mass:a,cg:h}}}function n(t,e,i,s){return t+e*(i-s)**2}function r(t,e,i,s,a,o){let h=e-t,r=s-i,l=o-a;(h<0||r<0||l<0)&&console.warn("trapezoidCalculation: Unsupported input. Possibly not a valid trapezoid.");let c=0==h&&0==r?a+.5*l:a+l*(2*h+r)/(3*(h+r)),f=t+.5*h,p=0===l?.25*(t+e+i+s):f+(i+.5*r-f)*(c-a)/l,u=(e-i)*l,d=.5*(i+e),b=(e-i)**3*l/12,g=.5*(e-s)*l,S=s+(e-s)/3,m=(e-s)**3*l/36;return{A:.5*(h+r)*l,xc:p,yc:c,Ix:0==h&&0==r?0:l**3*(h**2+4*h*r+r**2)/(36*(h+r)),Iy:n((i-t)**3*l/36,.5*(i-t)*l,t+(i-t)/3,p)+n(b,u,d,p)+n(m,g,S,p),maxX:Math.max.apply(null,[t,e,i,s]),minX:Math.min.apply(null,[t,e,i,s]),maxY:Math.max(a,o),minY:Math.min(a,o)}}function l({xs:t,ymins:e,ymaxs:i}){let s=[];for(let a=0;a<t.length-1;a++){let o=t[a],h=t[a+1],n=e[a]||0,l=i[a]||0,c=e[a+1]||0,f=i[a+1]||0;s.push(r(n,l,c,f,o,h))}let a=function(t){let e=0,i=0,s=0,a=0,o=0,h=0,r=0,l=t.length,c=!1,f=!1;for(let n=0;n<l;n++){let l=t[n];e+=l.A,i+=l.xc*l.A,s+=l.yc*l.A,!isNaN(l.maxX)&&l.maxX>a&&(a=l.maxX),!isNaN(l.minX)&&l.minX<o&&(o=l.minX),!isNaN(l.maxY)&&l.maxY>h&&!f&&c&&(h=l.maxY,0===l.A&&(f=!0)),isNaN(l.minY)||c||0!==l.A&&(r=l.minY,c=!0)}f||(h=t[l-1].maxY);let p=0,u=0;0!==e?(i/=e,s/=e):(i/=l,s/=l);for(let e=0;e<t.length;e++){let a=t[e];p+=n(a.Ix,a.A,a.yc,s),u+=n(a.Iy,a.A,a.xc,i)}return{A:e,xc:i,yc:s,Ix:p,Iy:u,maxX:a,minX:o,maxY:h,minY:r}}(s);return{A:a.A,maxX:a.maxY,minX:a.minY,maxY:a.maxX,minY:a.minX,xc:a.yc,yc:a.xc,Ix:a.Iy,Iy:a.Ix,Abb:(a.maxY-a.minY)*(a.maxX-a.minX)}}function c(t,e,i,a,o,h,n,r){let l=e-t,c=a-i,f=l*c,p=.25*(o+h+n+r),u=Math.abs(f*p),d=.5*p,b=t+l*((1/12*o+1/6*n+1/12*h+1/6*r)/(p||1)),g=i+c*((1/12*o+1/12*n+1/6*h+1/6*r)/(p||1)),S=Math.abs(function(t,e,i,a,o,h,n,r,l=5){let[c,f,p,u]=s(t,e,i,a,o,h,n,r),d=0,b=e-t,g=a-i,S=l,m=l;for(let e=0;e<S;e++){let s=t+(e+.5)/S*b;for(let t=0;t<m;t++){let e=i+(t+.5)/m*g;d+=Math.sqrt((f+u*e)**2+(p+u*s)**2+1)}}return d*=b*g/(S*m),d}(t,e,i,a,o,h,n,r));return{Ab:f,As:S,V:u,Cv:{x:b,y:g,z:d}}}class f extends t{constructor(t){super(t)}setFromSpecification(t){return this.halfBreadths=t.halfBreadths,this.attributes=t.attributes,this.levelsNeedUpdate=!0,this.style=t.style||{},this}getWeight(t){let e=this.attributes,i=e.BOA,s=e.Depth,a=t.calculationParameters,o=a.K,h=a.LWL_design,n=function(t,e,i,s,a,o,h){let n=e*(i+s)+.85*e*(a-s),r=o+(.8*a-s)/(3*s)*(1-o),l=t*Math.pow(n,1.36)*(1+.5*(r-.7)),c=0;return c=e<120?.01*a*(46.6+.135*(.81-o)*Math.pow(e/a,2))+.008*a*(e/a-6.5):.01*a*(46.6+.135*(.81-o)*Math.pow(e/a,2)),{mass:l,cg:{x:(h?.5*e+(9.7-45*h)*e/100:.516*e)-.15*e/100,y:0,z:c}}}(o,h,i,a.Draft_design,s,a.Cb_design,.514444*a.speed/Math.pow(9.81*h,.5));return n.mass*=1e3,n}getStation(t){let s,a=this.attributes,o=t/a.LOA,h=this.halfBreadths.stations,n=this.halfBreadths.waterlines,r=this.halfBreadths.table,{index:l,mu:c}=e(h,o);if(l<0||l>=h.length)s=new Array(n.length).fill(null);else if(l+1===h.length)s=r.map((t=>t[h.length-1]));else{s=[];for(let t=0;t<n.length;t++){let e=r[t][l],a=r[t][l+1];null!==e&&!isNaN(e)||null!==a&&!isNaN(a)?s.push(i(e||0,a||0,c)):s.push(null)}}for(let t=0;t<this.halfBreadths.waterlines.length;t++)s[t]*=.5*a.BOA,(isNaN(s[t])||null===s[t])&&(s[t]=null);return s}getWaterline(t){let s=this.attributes,a=t/s.Depth,o=this.halfBreadths.waterlines,h=this.halfBreadths.stations,n=this.halfBreadths.table;if(a<o[0])return new Array(h.length).fill(0);{let t,r;a>o[o.length-1]?(t=o.length-2,r=1):(({index:t,mu:r}=e(o,a)),t===o.length-1&&(t=o.length-2,r=1));let l=new Array(h.length);for(let e=0;e<l.length;e++){let a,h,c=t;if(null===n[c][e]||isNaN(n[c][e])){for(c=t+1;c<o.length&&(isNaN(n[c][e])||null===n[c][e]);)c++;if(c!==o.length)a=0;else{for(c=t-1;c>=0&&(isNaN(n[c][e])||null===n[c][e]);)c--;-1===c?(a=0,h=0):(a=n[c][e],h=a)}}else a=n[c][e];let f=t+1;if(void 0!==h);else if(null===n[f][e]||isNaN(n[f][e])){for(f=t+2;f<o.length&&(isNaN(n[f][e])||null===n[f][e]);)f++;h=f===o.length?a:n[f][e]}else h=n[f][e];l[e]=i(a,h,r),null===l[e]||isNaN(l[e])||(l[e]*=.5*s.BOA)}return l}}waterlineCalculation(t,s){let{minX:a,maxX:o,minY:h,maxY:n}=s||{},r=this.getWaterline(t),c=this.attributes.LOA,f=this.halfBreadths.stations.slice();for(let t=0;t<f.length;t++)f[t]*=c;let p=void 0!==a&&a!==f[0],u=void 0!==o&&o!==f[f.length-1];if(p||u){let t,s=0;if(p){let o;({index:s,mu:o}=e(f,a));let h=r[s],n=r[s+1];t=null!==h&&!isNaN(h)||null!==n&&!isNaN(n)?i(h||0,n||0,o):null}let h,n=f.length-1;if(u){let t;({index:n,mu:t}=e(f,o));let s=r[n],a=r[n+1];h=null!==s&&!isNaN(s)||null!==a&&!isNaN(a)?i(s||0,a||0,t):null}f=f.slice(s+1,n+1),r=r.slice(s+1,n+1),p&&(f.unshift(a),r.unshift(t)),u&&(f.push(o),r.push(h))}let d=[],b=[];for(let t=0;t<r.length;t++)null===r[t]||isNaN(r[t])?(b[t]=h||null,d[t]=n||null):(b[t]=Math.max(-r[t],h||-r[t]),d[t]=Math.min(r[t],n||r[t]));let g=l({xs:f,ymins:b,ymaxs:d}),S=g.maxX-g.minX,m=g.maxY-g.minY,w=g.A/(S*m),v=this.attributes.APP||g.minX,M=(this.attributes.FPP||g.maxX)-v;return{z:t,xc:g.xc,yc:g.yc,Awp:g.A,Ix:g.Ix,Iy:g.Iy,maxX:g.maxX,minX:g.minX,maxY:g.maxY,minY:g.minY,Cwp:w,LWL:S,LBP:M,BWL:m}}stationCalculation(t,s){let a=this.halfBreadths.waterlines.map((t=>this.attributes.Depth*t)),o=this.getStation(t);if(null!==s&&!isNaN(s)){let{index:t,mu:h}=e(a,s);t<a.length-1&&(a[t+1]=i(a[t],a[t+1],h),o[t+1]=i(o[t],o[t+1],h),a=a.slice(0,t+2),o=o.slice(0,t+2))}let h=l({xs:a,ymins:o.map((t=>-t)),ymaxs:o});return{x:t,yc:h.yc,zc:h.xc,A:h.A,Iz:h.Ix,Iy:h.Iy,maxZ:h.maxX,minZ:h.minX,maxY:h.maxY,minY:h.minY}}calculateAttributesAtDraft(t){function i(t,e,i={z:0,Vs:0,Vbb:0,As:0,minX:0,maxX:0,minY:0,maxY:0,prMinY:0,prMaxY:0,Ap:0,Cv:{x:0,y:0,z:0}}){let s=t.waterlineCalculation(e,{}),a={};Object.assign(a,s),a.prMinY=s.minY,a.prMaxY=s.maxY;let h=r(i.prMinY,i.prMaxY,a.prMinY,a.prMaxY,i.z,e).A;a.Ap=i.Ap+h,null!==s.minX&&!isNaN(s.minX)&&s.minX<=i.minX?a.minX=s.minX:a.minX=i.minX,null!==s.maxX&&!isNaN(s.maxX)&&s.maxX>=i.maxX?a.maxX=s.maxX:a.maxX=i.maxX,null!==s.minY&&!isNaN(s.minY)&&s.minY<=i.minY?a.minY=s.minY:a.minY=i.minY,null!==s.maxY&&!isNaN(s.maxY)&&s.maxY>=i.maxY?a.maxY=s.maxY:a.maxY=i.maxY,a.Vbb=(a.maxX-a.minX)*(a.maxY-a.minY)*e,a.maxXwp=s.maxX,a.minXwp=s.minX;let n=[],l=t.halfBreadths.stations.map((e=>e*t.attributes.LOA)),f=t.getWaterline(e),p=t.getWaterline(i.z);for(let t=0;t<l.length-1;t++){let s=c(l[t],l[t+1],i.z,e,-p[t],-f[t],-p[t+1],-f[t+1]);n.push(s);let a=c(l[t],l[t+1],i.z,e,p[t],f[t],p[t+1],f[t+1]);n.push(a)}let u=function(t){let e=0,i=0,s={x:0,y:0,z:0},a=t.length;for(let h=0;h<a;h++){let a=t[h];e+=a.V,i+=a.As,s=o.add(s,o.scale(a.Cv,a.V))}return s=o.scale(s,1/(e||a||1)),{V:e,As:i,Cv:s}}(n),d={x:u.Cv.x,y:u.Cv.z,z:u.Cv.y};return a.Vs=i.Vs+u.V,a.As=i.As+u.As,a.minXwp<=l[0]&&(a.As+=t.stationCalculation(a.minXwp,e).A),a.maxXwp>=l[l.length-1]&&(a.As+=t.stationCalculation(a.maxXwp,e).A),a.Cv=o.scale(o.add(o.scale(i.Cv,i.Vs),o.scale(d,u.V)),1/(a.Vs||2)),a.Cb=a.Vs/a.Vbb,a.Cp=a.Vs/(a.Ap*(a.maxX-a.minX)),a}if(null===t||isNaN(t))return void console.error("Hull.prototype.calculateAttributesAtDraft(T): No draft specified. Returning undefined.");(t<0||t>this.attributes.Depth)&&console.error("Hull.prototype.calculateAttributesAtDraft(T): Draft parameter "+t+"outside valid range of [0,Depth]. Returning undefined.");let s=this.halfBreadths.waterlines.map((t=>this.attributes.Depth*t));if(this.levelsNeedUpdate){this.levels=[];for(let t=0;t<s.length;t++){let e=i(this,s[t],this.levels[t-1]);0===t&&(e.As+=e.Awp),this.levels.push(e)}this.levelsNeedUpdate=!1}let a,{index:h,mu:n}=e(s,t);return a=0===n?this.levels[h]:i(this,t,this.levels[h]),{xcwp:a.xc,LCF:a.xc,ycwp:a.yc,TCF:a.yc,Awp:a.Awp,Ixwp:a.Ix,BMt:a.Ix/a.Vs,Iywp:a.Iy,BMl:a.Iy/a.Vs,maxXs:a.maxX,minXs:a.minX,maxYs:a.maxY,minYs:a.minY,Cwp:a.Cwp,LWL:a.LWL,LBP:a.LBP,BWL:a.BWL,Ap:a.Ap,Cp:a.Cp,Vs:a.Vs,Cb:a.Cb,Cm:a.Cb/a.Cp,As:a.As,Cv:a.Cv,LCB:a.Cv.x,TCB:a.Cv.y,KB:a.Cv.z}}calculateDraftAtMass(t,e=.001,i=1025){let s=t/i,a=0,o=this.attributes.Depth,h=.5*o,n=0-s,r=s;for(;Math.abs(h-a)>e;){h>o&&(h=o),r=this.calculateAttributesAtDraft(h).Vs-s;let t=(r-n)/(h-a);if(t>.1||t<-.1)a=h,n=r,h-=r/t;else{let t=.5*(a+h),e=this.calculateAttributesAtDraft(t).Vs-s;e>0?(h=t,r=e):(a=t,n=e)}}return h}getSpecification(){return{halfBreadths:this.halfBreadths,attributes:this.attributes,style:this.style}}}function p(t){let e=t.reduce(((t,e)=>t+e.mass),0),i=t.map((t=>o.scale(t.cg,t.mass)));return{mass:e,cg:o.scale(o.sum(i),1/e)}}class u extends t{constructor(t){super(t)}setFromSpecification(t){return this.hull=new f(t.hull),this.decks=t.decks,this.bulkheads=t.bulkheads,this}getSpecification(){return{hull:this.hull.getSpecification(),decks:this.decks,bulkheads:this.bulkheads}}getWeight(t){let e=[];e.push(this.hull.getWeight(t));let i=Object.values(this.decks);for(let t=0;t<i.length;t++){let s=i[t],a=s.zFloor+.5*s.thickness,o=s.yCentre,h=s.breadth,n=this.hull.waterlineCalculation(a,{minX:s.xAft,maxX:s.xFwd,minY:o-.5*h,maxY:o+.5*h});e.push({mass:n.Awp*s.thickness*s.density,cg:{x:n.xc,y:n.yc,z:a}})}let s=Object.values(this.bulkheads);for(let t=0;t<s.length;t++){let i=s[t],a=i.xAft+.5*i.thickness,o=this.hull.stationCalculation(a);e.push({mass:o.A*i.thickness*i.density,cg:{x:a,y:o.yc,z:o.zc}})}return p(e)}}class d extends t{constructor(t){super(t)}getSpecification(){if(this.cachedVersion!==this.version){var t={calculationParameters:this.calculationParameters,objectOverrides:this.objectOverrides};t=JSON.parse(JSON.stringify(t)),this.specCache=t,this.cachedVersion=this.version}return this.specCache}clone(){return new d(this.getSpecification())}getObjectState(t){if(void 0!==this.objectCache[t.id]){let e=this.objectCache[t.id];if(e.thisStateVer===this.version)return console.log("ShipState.getObjectState: Using cache."),e.state}console.log("ShipState.getObjectState: Not using cache.");let e={};Object.assign(e,t.baseObject.baseState),Object.assign(e,t.referenceState);let i=this.objectOverrides,s=[i.common,i.baseByID[t.baseObject.id],i.derivedByGroup[t.affiliations.group],i.derivedByID[t.id]];for(let t=0;t<s.length;t++){let i=s[t];if(!i)continue;let a=Object.keys(i);for(let t of a)void 0!==e[t]&&(e[t]=i[t])}return this.objectCache[t.id]={thisStateVer:this.version,state:e},e}getObjectStateProperty(t,e){return this.getObjectState(t)[e]}setFromSpecification(t){if(this.setInitialState(),this.objectCache={},!t)return void Object.assign(this,{calculationParameters:{},objectOverrides:{commmon:{},baseByID:{},derivedByGroup:{},derivedByID:{}}});this.calculationParameters=t.calculationParameters||{},this.objectOverrides={};let e=this.objectOverrides,i=t.objectOverrides||{};return e.common=i.common||{},e.baseByID=i.baseByID||{},e.derivedByGroup=i.derivedByGroup||{},e.derivedByID=i.derivedByID||{},this.version++,this}extend(t){Object.assign(this.calculationParameters,t.calculationParameters),this.calculatedProperties={};let e=this.objectOverrides,i=t.objectOverrides||{};Object.assign(e.common,i.common);let s=[i.baseByID,i.derivedByGroup,i.derivedByID],a=[e.baseByID,e.derivedByGroup,e.derivedByID];for(let t=0;t<s.length;t++){if(!s[t])continue;let e=Object.keys(s[t]);for(let i of e)void 0!==a[t][i]?Object.assign(a[t][i],s[t][i]):a[t][i]=s[t][i]}this.version++}override(t){let e=this.objectOverrides,i=t.objectOverrides,s=[t.calculationParameters,i.common],a=[this.calculationParameters,e.common];for(let t=0;t<s.length;t++){if(!s[t])continue;let e=Object.keys(s[t]);for(let i of e)void 0!==a[t][i]&&(a[t][i]=s[t][i])}s=[i.common,i.baseByID,i.derivedByGroup,i.derivedByID],a=[e.common,e.baseByID,e.derivedByGroup,e.derivedByID];for(let t=0;t<s.length;t++){if(!s[t])continue;let e=Object.keys(s[t]);for(let i of e)if(void 0!==a[t][i]){let e=a[t][i],o=s[t][i];if(!o)continue;let h=Object.keys(o);for(let t of h)void 0!==e[t]&&(e[t]=o[t])}}this.version++}setInitialState(){this.version=0,this.objectCache={},this.continuous={},this.discrete={}}}function b(t,e){g(t,(function(t){let i=new S(t);e(i)}))}function g(t,e,i=!0){let s=new XMLHttpRequest;s.open("GET",t,i),s.addEventListener("load",(function(i){if(200===s.status){let t=i.target.response;var a=JSON.parse(t);e(a)}else console.error("Error loading data from: "+t)})),s.send(null)}class S extends t{constructor(t){"string"==typeof t&&g(t,(function(e){t=e}),!1),super(t)}createShip3D(t,e){const i=this.designState;try{this.ship3D=new e(this,Object.assign({shipState:i},t))}catch(t){const e="Ship3D is not a constructor";if(t.message.includes(e)){const e="The Ship3D function passed as argument is in a wrong format",i="Please, verify if the argument was imported correctly on the parent function: import { Ship3D } from 'path/to/file'";console.error(`${e}: ${t.message}. ${i}`)}else console.error(t)}}calculateDraft(t,e=.001,i=1025){let s=this.getWeight(t).mass;return this.structure.hull.calculateDraftAtMass(s,e,i)}calculateStability(t){let e=this.getWeight(t),i=e.cg.z,s=e.cg.x,a=this.structure.hull.calculateDraftAtMass(e.mass),{BMt:o,BMl:h,KB:n,LCB:r,LCF:l,LWL:c,BWL:f}=this.structure.hull.calculateAttributesAtDraft(a),p=n+o-i,u=n+h-i,d=(r-s)/u,b=0,g=0,S=0;d<Math.tan(3*Math.PI/180)?(b=a-(c-l)*d,g=a+l*d,S=b-g):(b=null,g=null,S=null),d=180*Math.atan(d)/Math.PI,console.log(S);let m=e.cg.y/p;return m*=f,{w:e,T:a,GMt:p,GMl:u,KB:n,BMt:o,BMl:h,KG:i,trim:d,draftfp:b,draftap:g,trimd:S,heel:m}}getFuelMass(t){t=t||this.designState;let e={totalMass:0,tankMass:{},tankStates:{}};for(let i of Object.values(this.derivedObjects))"fuel tanks"===i.affiliations.group&&(e.tankStates[i.id]=t.getObjectState(i),e.tankMass[i.id]=i.baseObject.weightInformation.contentDensity*i.baseObject.weightInformation.volumeCapacity*e.tankStates[i.id].fullness,e.totalMass+=e.tankMass[i.id]);return e}subtractFuelMass(t,e){e=e||this.designState;for(var i=this.getFuelMass(e),s=i.totalMass,a=Object.entries(i.tankMass),o=0,h=0;h<a.length;h++){var n=a[h][0];o+=this.derivedObjects[n].baseObject.weightInformation.volumeCapacity*this.derivedObjects[n].baseObject.weightInformation.contentDensity}if(t<=s)for(h=0;h<a.length;h++){n=a[h][0];e.objectCache[n].state.fullness-=t/o}else{t-=s;for(h=0;h<a.length;h++){n=a[h][0];e.objectCache[n].state.fullness=0}console.error("Vessel ran out of fuel before "+t.toFixed(2)+" tons were subtracted.")}for(var r in e.objectCache)e.objectCache[r].thisStateVer++;e.version++}setFromSpecification(t){this.attributes=t.attributes||{},this.structure=new u(t.structure),this.baseObjects={};for(let e=0;e<t.baseObjects.length;e++){let i=t.baseObjects[e];this.baseObjects[i.id]=new a(i)}this.derivedObjects={};for(let e=0;e<t.derivedObjects.length;e++){let i=t.derivedObjects[e];this.derivedObjects[i.id]=new h(i,this.baseObjects)}return this.designState=new d(t.designState),this}getSpecification(){let t={};return t.attributes=this.attributes,t.structure=this.structure.getSpecification(),t.baseObjects=Object.values(this.baseObjects).map((t=>t.getSpecification())),t.derivedObjects=Object.values(this.derivedObjects).map((t=>t.getSpecification())),t.designState=this.designState.getSpecification(),t}getWeight(t){t=t||this.designState;let e=[];e.push(this.structure.getWeight(this.designState));for(let i of Object.values(this.derivedObjects))e.push(i.getWeight(t));return p(e)}validateObjectBond(t,e){if("string"!=typeof e||void 0===t[e])throw console.error("Undefined bond with ID '"+e+"' in the object"),new Error("validateObjectBond: object bond modification not valid")}changeObject(t,e){if("object"==typeof t)if("object"==typeof e)for(const i in e){const s=t.getSpecification()[i],a={};a[i]=Object.assign(s,e[i]),Object.assign(t,a)}else console.error("changeObject: spec must be an object.");else console.error("changeObject: object must be an object.")}getBaseObjectById(t=void 0){if(void 0===t)return this.baseObjects;const e=Array.isArray(t)?t:[t];let i={};for(let t of e){const e=this.baseObjects[t];e?i[t]=e:console.warn(`BaseObject with id ${t} not found.`)}return i}changeBaseObjectById(t,e){this.validateObjectBond(this.baseObjects,t),this.changeObject(this.baseObjects[t],e)}changeDerivedObjectById(t,e){this.validateObjectBond(this.derivedObjects,t),this.changeObject(this.derivedObjects[t],e),"baseObject"in e&&console.error("Key 'baseObject' identified under the spec. Please, use change changeBaseObjectById if you want to change the base object.")}deleteBaseObjectById(t){this.validateObjectBond(this.baseObjects,t),delete this.baseObjects[t];for(const[e,i]of Object.entries(this.derivedObjects))i.baseObject.id===t&&this.deleteDerivedObjectById(e)}deleteDerivedObjectById(t){this.validateObjectBond(this.derivedObjects,t),delete this.derivedObjects[t]}addNewObject(t){if("object"==typeof t)if(Array.isArray(t.baseObject)&&Array.isArray(t.derivedObjects)){for(let e of t.baseObject)this.baseObjects[e.id]=new a(e);for(let e of t.derivedObjects)this.validateObjectBond(this.baseObjects,e.id),this.derivedObjects[e.id]=new h(e,this.baseObjects)}else console.error("addObject: spec.baseObject must be an array.");else console.error("changeObject: spec must be an object.")}}class m{constructor(t,e=3600){this.waveDef={},this.version=0,this.defList=t||[[.6,2.25,180],[1.1,1.75,150]],this.setWaveDef=function(t,e,i){var s;s={waveFreq:t,waveAmplitude:e,heading:i},JSON.stringify(this.waveDef)!==JSON.stringify(s)&&(this.waveDef=s,this.version++)},this.setRandom=function(){var t=this.defList[Math.floor(Math.random()*this.defList.length)];this.setWaveDef(t[0],t[1],t[2])},this.setTime=function(t){var e=t/this.waveDuration,i=Math.floor(e%this.defList.length);this.setWaveDef(this.defList[i][0],this.defList[i][1],this.defList[i][2])}}}class w{constructor(t,e){this.ship=t,this.states=e}returnOutput(){let t={};for(let e=0;e<this.output.length;e++){let i=this[this.output[e]];"number"==typeof i?t[this.output[e]]=i:"object"==typeof i&&Object.assign(t,i)}return t}writeOutput(){let t=this.constructor.name;void 0===this.states.discrete[t]&&(this.states.discrete[t]={state:{},thisStateVer:0});for(let e=0;e<this.output.length;e++){let i=this[this.output[e]];"number"==typeof i?this.states.discrete[t].state[this.output[e]]=i:"object"==typeof i&&Object.assign(this.states.discrete[t].state,i)}this.states.discrete[t].thisStateVer++}setDraft(){let t=this.ship.calculateDraft(this.states);void 0===this.states.discrete.FloatingCondition&&(this.states.discrete.FloatingCondition={state:{},thisStateVer:0}),Object.assign(this.states.discrete.FloatingCondition.state,this.ship.structure.hull.calculateAttributesAtDraft(t)),Object.assign(this.states.discrete.FloatingCondition.state,this.ship.calculateStability(this.states)),this.states.discrete.FloatingCondition.thisStateVer++}setSpeed(t){void 0===this.states.discrete.Speed&&(this.states.discrete.Speed={state:{},thisStateVer:0}),void 0===t&&void 0!==this.ship.designState.calculationParameters.speed&&(t=this.ship.designState.calculationParameters.speed),this.states.discrete.Speed.state.speed=t,this.states.discrete.Speed.thisStateVer++}setHeading(t){void 0===this.states.discrete.Heading&&(this.states.discrete.Heading={state:{},thisStateVer:0}),void 0===t&&(t=0),this.states.discrete.Heading.state.heading=t,this.states.discrete.Heading.thisStateVer++}memoized(t,e){return{enumerable:!0,configurable:!1,get:function(){let i;if(i=void 0!==this.wavCre,void 0===this.cache[e]){this.cache[e]={};for(let t=0;t<this.cacheDependence.length;t++){let i=this.cacheDependence[t];this.cache[e][i+"Version"]=0}i&&(this.cache[e].waveStateVersion=0)}let s=!1;for(let t=0;t<this.cacheDependence.length;t++){let i=this.cacheDependence[t];if(this.cache[e][i+"Version"]!==this.states.discrete[i].thisStateVer){s=!0;break}}if(i&&!1===s&&this.cache[e].waveStateVersion!==this.wavCre.version&&(s=!0),s){this.cache[e].value=t.call(this);for(let t=0;t<this.cacheDependence.length;t++){let i=this.cacheDependence[t];this.cache[e][i+"Version"]=this.states.discrete[i].thisStateVer}i&&(this.cache[e].waveStateVersion=this.wavCre.version)}return this.cache[e].value}}}}class v extends w{constructor(t,e,i,s=0,a=20,o=9.81,h=1025){super(t,e),void 0===this.states.discrete.FloatingCondition&&this.setDraft(),void 0===this.states.discrete.Speed&&this.setSpeed(),void 0===this.states.discrete.Heading&&this.setHeading(),this.floatState=this.states.discrete.FloatingCondition.state,this.speedState=this.states.discrete.Speed.state,this.headingState=this.states.discrete.Heading.state,this.wavCre=i,this.position=s,this.g=o,this.rho=h,this.critical_damping_percentage=a,this.delta=this.ship.structure.hull.attributes.prismaticLengthRatio,this.output=["verticalMotion"],this.cacheDependence=["FloatingCondition","Speed","Heading"],this.cache={},Object.defineProperties(this,{coefficients:w.prototype.memoized((function(){var t=Math.abs(this.wavCre.waveDef.heading-this.headingState.heading)*Math.PI/180,e=.514444*this.speedState.speed/Math.sqrt(this.g*this.floatState.LWL),i=Math.pow(this.wavCre.waveDef.waveFreq,2)/this.g,s=Math.abs(i*Math.cos(t)),a=Math.exp(-i*this.floatState.T),o=1-e*Math.sqrt(i*this.floatState.LWL)*Math.cos(t);return{betha:t,Froude_N:e,wave_number:i,eff_wave_number:s,smith_factor:a,alpha:o,encounter_frequency:this.wavCre.waveDef.waveFreq*o}}),"coefficients"),verticalMotion:w.prototype.memoized((function(){var t,e,i=this.floatState.BWL*this.floatState.Cb,s=this.position/100*this.ship.structure.hull.attributes.LOA-this.states.discrete.FloatingCondition.state.w.cg.x,a=2*Math.sin(.5*this.coefficients.wave_number*i*Math.pow(this.coefficients.alpha,2))*Math.exp(-this.coefficients.wave_number*this.floatState.T*Math.pow(this.coefficients.alpha,2));t=Math.pow(1-this.coefficients.wave_number*this.floatState.T,2),e=Math.pow(Math.pow(a,2)/(this.coefficients.wave_number*i*Math.pow(this.coefficients.alpha,3)),2);var o=Math.sqrt(t+e),h=1/Math.sqrt(Math.pow(1-2*this.coefficients.wave_number*this.floatState.T*Math.pow(this.coefficients.alpha,2),2)+Math.pow(Math.pow(a,2)/(this.coefficients.wave_number*i*Math.pow(this.coefficients.alpha,2)),2)),n=this.coefficients.smith_factor*o*(2/(this.coefficients.eff_wave_number*this.floatState.LWL))*Math.sin(this.coefficients.eff_wave_number*this.floatState.LWL/2),r=this.wavCre.waveDef.waveAmplitude*h*n,l=this.coefficients.smith_factor*o*(24/(Math.pow(this.coefficients.eff_wave_number*this.floatState.LWL,2)*this.floatState.LWL))*(Math.sin(this.coefficients.eff_wave_number*this.floatState.LWL/2)-this.coefficients.eff_wave_number*this.floatState.LWL/2*Math.cos(this.coefficients.eff_wave_number*this.floatState.LWL/2)),c=this.wavCre.waveDef.waveAmplitude*h*l,f=Math.abs(c*s),p=Math.pow(this.coefficients.encounter_frequency,2)*f,u=Math.abs(r),d=Math.pow(this.coefficients.encounter_frequency,2)*Math.abs(r),b=Math.sqrt(Math.pow(u,2)+Math.pow(f,2));return{pitchAmp:c,pitchMov:f,pitchAcc:p,heaveAmp:u,heaveAcc:d,verticalMov:b,verticalAcc:Math.pow(this.coefficients.encounter_frequency,2)*b}}),"verticalMotion"),bendingMoment:w.prototype.memoized((function(){var t=2.5*(1-Math.max(.6,this.floatState.Cb)),e=Math.pow(1-t,2)+.6*this.coefficients.alpha*(2-t),i=1+3*Math.pow(this.coefficients.Froude_N,2);return this.wavCre.waveDef.waveAmplitude*(this.coefficients.smith_factor*((1-this.coefficients.wave_number*this.floatState.T)/Math.pow(this.floatState.LWL*this.coefficients.eff_wave_number,2))*(1-Math.cos(this.coefficients.eff_wave_number*this.floatState.LWL/2)-this.coefficients.eff_wave_number*this.floatState.LWL/4*Math.sin(this.coefficients.eff_wave_number*this.floatState.LWL/2))*i*e*Math.pow(Math.abs(Math.cos(this.coefficients.betha)),1/3))*this.rho*this.g*this.floatState.BWL*Math.pow(this.floatState.LWL,2)/1e6}),"bendingMoment"),rollAmp:w.prototype.memoized((function(){var t,e,i,s=2*this.floatState.BWL*Math.PI*.8/2/Math.pow(this.g*this.floatState.GMt,.5),a=(this.floatState.Cwp-this.delta)/(1-this.delta),o=this.floatState.Cb*this.floatState.BWL*this.floatState.T/(this.delta+a*(1-this.delta)),h=this.floatState.BWL/this.floatState.T;3<=h&&h<=6?(t=.256*h-.286,e=-.11*h-2.55,i=.033*h-1.419):1<=h&&h<3?(t=-3.94*h+13.69,e=-2.12*h-1.89,i=1.16*h-7.97):console.error("The B/T relation is not being respected for the roll formula. It should be 1 <= B/T < 6, not "+(this.floatState.BWL/this.floatState.T).toFixed(2)+".");var n,r,l,c=this.rho*o*Math.pow(this.floatState.BWL,2)*t*Math.exp(e*Math.pow(this.coefficients.encounter_frequency,-1.3))*Math.pow(this.coefficients.encounter_frequency,i)/Math.sqrt(this.floatState.BWL/(2*this.g)),f=a*o,p=a*this.floatState.BWL,u=p/this.floatState.T;3<=u&&u<=6?(n=.256*u-.286,r=-.11*u-2.55,l=.033*u-1.419):1<=u&&u<3?(n=-3.94*u+13.69,r=-2.12*u-1.89,l=1.16*u-7.97):console.error("The vessel dimensions are out of range for the roll formula.");var d,b,g,S,m,w=this.rho*f*Math.pow(p,2)*n*Math.exp(r*Math.pow(this.coefficients.encounter_frequency,-1.3))*Math.pow(this.coefficients.encounter_frequency,l)/Math.sqrt(p/(2*this.g)),v=this.floatState.LWL*c*(this.delta+w*(1-this.delta)/c),M=this.critical_damping_percentage/100,y=this.g*this.rho*this.floatState.Cb*this.floatState.LWL*this.floatState.BWL*this.floatState.T*this.floatState.GMt,L=y*s/Math.PI,x=Math.sqrt(w/c),O=v+L*M;return 90==this.wavCre.waveDef.heading||270==this.wavCre.waveDef.heading?d=Math.sqrt(this.rho*Math.pow(this.g,2)*c/this.coefficients.encounter_frequency)*(this.delta+x*(1-this.delta))*this.floatState.LWL:(b=Math.abs(Math.sin(this.coefficients.betha))*Math.sqrt(this.rho*Math.pow(this.g,2)/this.coefficients.encounter_frequency)*Math.sqrt(c)*2/this.coefficients.eff_wave_number,g=Math.pow(Math.sin(.5*this.delta*this.floatState.LWL*this.coefficients.eff_wave_number),2),S=Math.pow(x*Math.sin(.5*(1-this.delta)*this.floatState.LWL*this.coefficients.eff_wave_number),2),m=2*x*Math.sin(.5*this.delta*this.floatState.LWL*this.coefficients.eff_wave_number)*Math.sin(.5*(1-this.delta)*this.floatState.LWL*this.coefficients.eff_wave_number)*Math.cos(.5*this.floatState.LWL*this.coefficients.eff_wave_number),d=b*Math.sqrt(g+S+m)),b=Math.pow(1-Math.pow(this.coefficients.encounter_frequency*s/(2*Math.PI),2),2),g=Math.pow(y,2),S=Math.pow(this.coefficients.encounter_frequency*O,2),this.wavCre.waveDef.waveAmplitude*d/Math.sqrt(b*g+S)}),"rollAmp")})}}class M extends w{constructor(t,e,i,s,a=9.81,o=1025,h=.00122){super(t,e),this.propeller=i,void 0===this.states.discrete.FloatingCondition&&this.setDraft(),void 0===this.states.discrete.Speed&&this.setSpeed(),this.speedState=this.states.discrete.Speed.state,this.floatState=this.states.discrete.FloatingCondition.state,this.wavCre=s,this.g=a,this.rho=o,this.mi=h,this.b=this.ship.structure.hull.attributes.bulb,this.tr=this.ship.structure.hull.attributes.transom,this.cstern=this.ship.structure.hull.attributes.cstern,this.appendices=this.ship.structure.hull.attributes.appendices,this.output=["totalResistance","efficiency"],this.cacheDependence=["FloatingCondition","Speed"],this.cache={},Object.defineProperties(this,{coefficients:w.prototype.memoized((function(){let t,e,i=100*(this.floatState.LCB-(this.floatState.minXs+this.floatState.LWL/2))/this.floatState.LWL;t=null===this.floatState.draftfp?this.floatState.T:this.floatState.draftfp,e=null===this.floatState.draftap?this.floatState.T:this.floatState.draftap;let s,a=(t+e)/2,o=t/2,h=Math.PI*Math.pow(t/2,2)*this.b/7.7,n=.56*Math.pow(h,1.5)/(this.floatState.BWL*a*(.31*Math.pow(h,.5)+t-o)),r=Math.exp(-1.89*Math.pow(n,.5));s=t/this.floatState.LWL>.04?.04:t/this.floatState.LWL;let l=.006*Math.pow(this.floatState.LWL+100,-.16)-.00205+.003*Math.pow(this.floatState.LWL/7.5,.5)*Math.pow(this.floatState.Cb,4)*r*(.04-s),c=this.floatState.LWL*(2*a+this.floatState.BWL)*Math.pow(this.floatState.Cm,.5)*(.453+.4425*this.floatState.Cb-.2862*this.floatState.Cm-.003467*this.floatState.BWL/a+.3696*this.floatState.Cwp)+2.38*h/this.floatState.Cb,f=this.floatState.LWL*(1-this.floatState.Cp+.06*this.floatState.Cp*(i/100)/(4*this.floatState.Cp-1)),p=.93+.487118*(1+.011*this.cstern)*Math.pow(this.floatState.BWL/this.floatState.LWL,1.06806)*Math.pow(a/this.floatState.LWL,.46106)*Math.pow(this.floatState.LWL/f,.121563)*Math.pow(Math.pow(this.floatState.LWL,3)/this.floatState.Vs,.36486)*Math.pow(1-this.floatState.Cp,-.604247),u=.514444*this.speedState.speed,d=this.rho*this.floatState.LWL*u/this.mi;return{lcb:i,Tfore:t,Taft:e,T:a,hb:o,c2:r,ca:l,abt:h,wa:c,lr:f,k:p,speedSI:u,cf:.075/Math.pow(Math.log(d)/Math.log(10)-2,2)}}),"coefficients"),calmResistance:w.prototype.memoized((function(){let t,e,i=.95*(this.coefficients.Taft-.9225*this.coefficients.Taft)*this.floatState.BWL*.89*this.tr,s=.5*this.rho*Math.pow(this.coefficients.speedSI,2)*this.coefficients.wa*this.coefficients.cf;t=0===i?0:this.coefficients.speedSI/Math.pow(2*this.g*i/(this.floatState.BWL+this.floatState.BWL*this.floatState.Cwp),.5),e=t<5?.2*(1-.2*t):0;let a,o=.5*this.rho*Math.pow(this.coefficients.speedSI,2)*i*e,h=0,n=0;for(let t in this.appendices)h+=this.appendices[t].area,n+=this.appendices[t].coeff*this.appendices[t].area;a=0!==h?n/h:0;let r,l=.5*this.rho*Math.pow(this.coefficients.speedSI,2)*h*a*this.coefficients.cf,c=this.coefficients.speedSI/Math.pow(this.g*this.floatState.LWL,.5);r=this.floatState.BWL/this.floatState.LWL<.11?.229577*Math.pow(this.floatState.BWL/this.floatState.LWL,.33333):this.floatState.BWL/this.floatState.LWL<.25?this.floatState.BWL/this.floatState.LWL:.5-.0625*this.floatState.LWL/this.floatState.BWL;let f,p,u=1+89*Math.exp(-Math.pow(this.floatState.LWL/this.floatState.BWL,.80856)*Math.pow(1-this.floatState.Cwp,.30484)*Math.pow(1-this.floatState.Cp-this.coefficients.lcb/100*.0225,.6367)*Math.pow(this.coefficients.lr/this.floatState.BWL,.34574)*Math.pow(this.floatState.Vs/Math.pow(this.floatState.LWL,3)*100,.16302)),d=2223105*Math.pow(r,3.78613)*Math.pow(this.coefficients.T/this.floatState.BWL,1.07961)*Math.pow(90-u,-1.37565),b=1-.8*i/(this.floatState.BWL*this.coefficients.T*this.floatState.Cm);f=Math.pow(this.floatState.LWL,3)/this.floatState.Vs<512?-1.69385:Math.pow(this.floatState.LWL,3)/this.floatState.Vs<1726.91?(this.floatState.LWL/Math.pow(this.floatState.Vs,1/3)-8)/2.36-1.69385:0,p=this.floatState.Cp<.8?8.07981*this.floatState.Cp-13.8673*Math.pow(this.floatState.Cp,2)+6.984388*Math.pow(this.floatState.Cp,3):1.73014-.7067*this.floatState.Cp;let g,S=this.floatState.LWL/this.coefficients.T*.0140407-Math.pow(this.floatState.Vs,1/3)/this.floatState.LWL*1.75254-this.floatState.BWL/this.floatState.LWL*4.79323-p;g=this.floatState.LWL/this.floatState.BWL>12?1.446*this.floatState.Cp-.36:1.446*this.floatState.Cp-this.floatState.LWL/this.floatState.BWL*.03;let m,w,v,M,y,L=6919.3*Math.pow(this.floatState.Cm,-1.3346)*Math.pow(this.floatState.Vs/Math.pow(this.floatState.LWL,3),2.00977)*Math.pow(this.floatState.LWL/this.floatState.BWL-2,1.40692),x=-7.2035*Math.pow(this.floatState.BWL/this.floatState.LWL,.326869)*Math.pow(this.coefficients.T/this.floatState.BWL,.605375),O=.4*f*Math.exp(-.034*Math.pow(.4,-3.29)),j=d*this.coefficients.c2*b*this.floatState.Vs*this.rho*this.g*Math.exp(S*Math.pow(.4,-.9)+O*Math.cos(g*Math.pow(.4,-2))),C=.4*f*Math.exp(-.034*Math.pow(.55,-3.29)),D=L*this.coefficients.c2*b*this.floatState.Vs*this.rho*this.g*Math.exp(x*Math.pow(.55,-.9)+C*Math.cos(g*Math.pow(.55,-2)));0===c?(m=0,w=0,v=0,M=0):(m=.4*f*Math.exp(-.034*Math.pow(c,-3.29)),w=d*this.coefficients.c2*b*this.floatState.Vs*this.rho*this.g*Math.exp(S*Math.pow(c,-.9)+m*Math.cos(g*Math.pow(c,-2))),v=L*this.coefficients.c2*b*this.floatState.Vs*this.rho*this.g*Math.exp(x*Math.pow(c,-.9)+m*Math.cos(g*Math.pow(c,-2))),M=j+(10*c-4)*(D-j)/1.5),y=c<.4?w:c<=.55?M:v;let W,B=this.coefficients.speedSI/Math.sqrt(this.g*(this.coefficients.Tfore-this.coefficients.hb-.25*Math.pow(this.coefficients.abt,.5))+.15*Math.pow(this.coefficients.speedSI,2)),A=.56*Math.pow(this.coefficients.abt,.5)/(this.coefficients.Tfore-1.5*this.coefficients.hb);W=0===this.coefficients.abt?0:.11*Math.exp(-3*Math.pow(A,-2))*Math.pow(B,3)*Math.pow(this.coefficients.abt,1.5)*this.rho*this.g/(1+Math.pow(B,2));let P=.455*this.rho*Math.pow(this.coefficients.speedSI,2)*this.coefficients.wa*this.coefficients.ca;return(this.floatState.LWL/this.floatState.BWL<=3.9||this.floatState.LWL/this.floatState.BWL>=15)&&console.error("The L/B relation is not being respected. It should be 3.9 < L/B < 15, not "+(this.floatState.LWL/this.floatState.BWL).toFixed(2)+"."),(this.floatState.BWL/this.coefficients.T<=2.1||this.floatState.BWL/this.coefficients.T>=4)&&console.error("The B/T relation is not being respected. It should be 2.1 < B/T < 4, not "+(this.floatState.BWL/this.coefficients.T).toFixed(2)+"."),(this.floatState.Cp<=.55||this.floatState.Cp>=.85)&&console.error("The prismatic coefficient is not being respected. It should be 0.55 < Cp < 0.85, not "+this.floatState.Cp.toFixed(2)+"."),this.coefficients.k*s+l+y+W+o+P}),"calmResistance"),totalResistance:w.prototype.memoized((function(){let t,e=2*this.wavCre.waveDef.waveAmplitude;if(e<=2){let i=.64*Math.pow(e*this.floatState.BWL,2)*this.floatState.Cb*this.rho*this.g/this.floatState.LWL;t=this.calmResistance+i}else t=1.2*this.calmResistance;return{Rtadd:t,Pe:this.coefficients.speedSI*t}}),"totalResistance"),efficiency:w.prototype.memoized((function(){let t,e,i,s;t=this.floatState.BWL/this.coefficients.Taft<5?this.floatState.BWL*this.coefficients.wa/(this.floatState.LWL*this.propeller.D*this.coefficients.Taft):this.coefficients.wa*(7*this.floatState.BWL/this.coefficients.Taft-25)/(this.floatState.LWL*this.propeller.D*(this.floatState.BWL/this.coefficients.Taft-3)),e=t<28?t:32-16/(t-24),i=this.coefficients.Taft/this.propeller.D<2?this.coefficients.Taft/this.propeller.D:.0833333*Math.pow(this.coefficients.Taft/this.propeller.D,3)+1.33333,s=this.floatState.Cp<.7?.12997/(.95-this.floatState.Cb)-.11056/(.95-this.floatState.Cp):.18567/(1.3571-this.floatState.Cm)-.71276+.38648*this.floatState.Cp;let a,o,h=1.45*this.floatState.Cp-.315-.0225*this.coefficients.lcb,n=this.coefficients.k*this.coefficients.cf+this.coefficients.ca,r=1+.015*this.cstern;return 1===this.propeller.noProps?a=e*r*n*this.floatState.LWL/this.coefficients.Taft*(.050776+.93405*i*n/(1-h))+.27915*r*Math.pow(this.floatState.BWL/(this.floatState.LWL*(1-h)),.5)+s*r:2===this.propeller.noProps&&(a=.3095*this.floatState.Cb+10*n*this.floatState.Cb-.23*this.propeller.D/Math.pow(this.floatState.BWL*this.coefficients.T,.5)),1===this.propeller.noProps?o=.25014*Math.pow(this.floatState.BWL/this.floatState.LWL,.28956)*Math.pow(Math.pow(this.floatState.BWL*this.coefficients.T,.5)/this.propeller.D,.2624)/Math.pow(1-this.floatState.Cp+.0225*this.coefficients.lcb,.01762)+.0015*this.cstern:2===this.propeller.noProps&&(o=.325*this.floatState.Cb-.1885*this.propeller.D/Math.pow(this.floatState.BWL*this.coefficients.T,.5)),{w:a,t:o,etah:(1-o)/(1-a)}}),"efficiency")})}}class y extends w{constructor(t,e,i,s=1025){super(t,e),this.propeller=i,void 0===this.states.discrete.FloatingCondition&&this.setDraft(),void 0===this.states.discrete.Speed&&this.setSpeed(),this.speedState=this.states.discrete.Speed.state,this.floatState=this.states.discrete.FloatingCondition.state,this.resistanceState=this.states.discrete.HullResistance.state,this.rho=s,this.output=["propulsion"],this.cacheDependence=["FloatingCondition","Speed"],this.cache={},Object.defineProperties(this,{propulsion:w.prototype.memoized((function(){0===this.speedSI&&console.error("Speed equals to zero, try getPropResult() method to get boolard pull or use changeSpeed() method to set a non null value.");var t,e=.514444*this.speedState.speed,i=100*(this.floatState.LCB-(this.floatState.minXs+this.floatState.LWL/2))/this.floatState.LWL,s=e/(1-this.resistanceState.w),a=this.resistanceState.Rtadd/(this.propeller.noProps*(1-this.resistanceState.t))/(this.rho*Math.pow(this.propeller.D*s,2)),o=this.propeller.beta2,h=-this.propeller.beta1,n=(-o+Math.pow(Math.pow(o,2)-4*a*h,.5))/(2*a),r=s/(n*this.propeller.D),l=this.propeller.beta1-this.propeller.beta2*n,c=this.propeller.gamma1-this.propeller.gamma2*n,f=n*l/(2*Math.PI*c);1===this.propeller.noProps?t=.9922-.05908*this.propeller.AeAo+.07424*(this.floatState.Cp-.0225*i):2===this.propeller.noProps&&(t=.9737+.111*(this.floatState.Cp-.0225*i)-.06325*this.propeller.P/this.propeller.D);var p=f*this.resistanceState.etah*t;return{eta:p,Ps:this.resistanceState.Pe/p,n:r,Va:s}}),"propulsion")})}}function L(t){let e=t.getSpecification(),i=JSON.stringify(e),s=document.createElement("a");s.href="data:application/json,"+encodeURIComponent(i),s.download="shipdesignspecification.json",s.target="_blank",s.click()}class x extends w{constructor(t,e,i){super(t,e),this.propellerState=this.states.discrete.PropellerInteraction.state,this.setAuxPower=function(t){void 0===t&&(t=0),void 0===this.states.discrete.AuxPower&&(this.states.discrete.AuxPower={state:{},thisStateVer:0}),this.states.discrete.AuxPower.state.Paux=t,this.states.discrete.AuxPower.thisStateVer++},void 0===this.states.discrete.AuxPower&&this.setAuxPower(0),this.auxPowerState=this.states.discrete.AuxPower.state,this.powerPlant=i,this.output=["consumptionRate"],this.cacheDependence=["PropellerInteraction"],this.cache={},Object.defineProperties(this,{consumptionRate:w.prototype.memoized((function(){function t(t,e){for(var i=0,s=[],a=0;a<t.engines.length;a++)s[a]=t.engines[a].MCR;"number"==typeof t.etag?e/=t.etas*t.etag:e/=t.etas;var o,h=s.reduce(((t,e)=>t+e),0),n=h-s[s.length-1],r=Array(s.length);if(e<=.8*n){var l=0;r.fill(0);for(var c=0;c<s.length;c++)if(e<=.8*(l+=s[c])){for(a=0;a<=c;a++)r[a]=e/l;break}}else.8*n<e&&e<=h?r.fill(e/h):e>h&&(console.error("Engines are overloaded. Power plant can't provide current required power."),r.fill(1));for(a=0;a<r.length;a++)r[a]>0&&(3===t.engines[a].polOrder?o=t.engines[a].a*Math.pow(r[a],3)+t.engines[a].b*Math.pow(r[a],2)+t.engines[a].c*r[a]+t.engines[a].d:2===t.engines[a].polOrder&&(o=t.engines[a].a*Math.pow(r[a],2)+t.engines[a].b*r[a]+t.engines[a].c),i+=o/36e5*r[a]*s[a]);return i}var e;return"object"==typeof this.powerPlant.auxiliary?(e=this.powerPlant.main.noSys*t(this.powerPlant.main,this.propellerState.Ps/(1e3*this.powerPlant.main.noSys)),e+=t(this.powerPlant.auxiliary,this.auxPowerState.Paux/1e3)):e=t(this.powerPlant.main,(this.propellerState.Ps+this.auxPowerState.Paux)/1e3),e}),"consumptionRate")})}}class O{constructor(t,e,i){this.ship=t,this.states=e,this.routeData={},this.routeData.pathVec=[],this.routeData.unitPath=[],this.routeData.heading=[],this.routeData.totalDist=0,this.routeData.legDistance=[];for(var s=0;s<i.length-1;s++){this.routeData.pathVec[s]=i[s+1].map(((t,e)=>t-i[s][e])),this.routeData.legDistance[s]=Math.sqrt(this.routeData.pathVec[s].map((t=>Math.pow(t,2))).reduce(((t,e)=>t+e))),this.routeData.unitPath[s]=this.routeData.pathVec[s].map((t=>t/this.routeData.legDistance[s]));var a=Math.acos(this.routeData.pathVec[s][1]/this.routeData.legDistance[s]);a*=180/Math.PI,this.routeData.pathVec[s][0]<0&&(a=360-a),this.routeData.heading[s]=a,this.routeData.totalDist+=this.routeData.legDistance[s]}this.states.continuous.Positioning={},this.states.continuous.Positioning.position=i[0],this.states.continuous.Positioning.travelLegDist=0,this.states.continuous.Positioning.travelDist=0,this.positionState=this.states.continuous.Positioning,this.states.discrete.Leg={state:{leg:0},thisStateVer:1},this.legState=this.states.discrete.Leg.state,void 0===this.states.discrete.Speed&&w.prototype.setSpeed.call(this),void 0===this.states.discrete.Heading&&w.prototype.setHeading.call(this,this.routeData.heading[0]),this.advanceShip=function(t){for(var e,s,a=1*t/3600*this.states.discrete.Speed.state.speed;0<a;)if(e=i[this.legState.leg+1].map(((t,e)=>t-this.positionState.position[e])),s=Math.sqrt(e.map((t=>Math.pow(t,2))).reduce(((t,e)=>t+e))),a<=s)this.positionState.position=this.positionState.position.map(((t,e)=>t+a*this.routeData.unitPath[this.legState.leg][e])),this.positionState.travelLegDist=this.positionState.travelLegDist+a,this.positionState.travelDist=this.positionState.travelDist+a,a=0;else{if(void 0===i[this.legState.leg+2]){this.positionState.position=this.positionState.position.map(((t,e)=>t+a*this.routeData.unitPath[this.legState.leg][e])),this.positionState.travelLegDist=this.positionState.travelLegDist+a,this.positionState.travelDist=this.positionState.travelDist+a,console.log("Vessel reached final destination.");break}a-=s,this.positionState.position=i[this.legState.leg+1],this.positionState.travelLegDist=0,this.positionState.travelDist=this.positionState.travelDist+s,this.legState.leg++,this.states.discrete.Leg.thisStateVer++,w.prototype.setHeading.call(this,this.routeData.heading[this.legState.leg]),console.log("Vessel reached pivot point in navigation and entered leg "+this.legState.leg+".")}}}}class j extends w{constructor(t,e,i,s,a,o,h=1025){super(t,e),void 0===this.states.discrete.FloatingCondition&&this.setDraft(),void 0===this.states.discrete.Speed&&this.setSpeed(),this.hullRes=i,this.propellerInteraction=s,this.fuelConsumption=a,this.powerPlant=a.powerPlant,this.manoeuvring=o,this.state={},this.rho=s.rho,this.propeller=this.propellerInteraction.propeller,this.speedState=this.states.discrete.Speed.state,this.floatState=this.states.discrete.FloatingCondition.state,this.resistanceState=this.states.discrete.HullResistance.state;const n=o.initial_yaw||0,r=o.initial_angle||0;Object.assign(this.states,{DX:{x:0,y:0,yaw:0},V:{u:0,v:0,yaw_dot:0},n:0,yaw:n,rudderAngle:r,load:0});var l=this.powerPlant.main.engines;this.powerPlant.engCapac=[];for(var c=this.powerPlant.engCapac,f=0;f<l.length;f++)c[f]=l[f].MCR;this.totalCapac=c.reduce(((t,e)=>t+e),0);const p=t.getWeight();this.m=o.m||p.mass;var u=this.ship.structure.hull.attributes,d=this.ship.designState.calculationParameters.Draft_design,b=o.I||Math.PI*h*u.LOA*u.BOA*d*(4*Math.pow(d,2)+Math.pow(u.BOA,2))/120;this.M_RB=o.M||[[this.m,0,0],[0,this.m,0],[0,0,b]],this.output=["hydroCoeff","dn"],this.cacheDependence=["PropellerInteraction","FloatingCondition"],this.cache={},Object.defineProperties(this,{hydroCoeff:w.prototype.memoized((function(){var t=this.ship.structure.hull.attributes,e=this.states.discrete.FloatingCondition.state,i=this.ship.designState.calculationParameters,s=t.LOA,a=t.Depth,o=t.BOA,h=i.Cb_design||e.Cb,n=e.Vs,r=i.Draft_design,l=this.rho,c=1-.7/(28.7*(n/Math.pow(s,3))+.54),f=Math.pow;const p=Math.PI,u=s/a,d=o/s,b=o/r,g=f(d,2),S=f(b,2),m=f(r/s,2);var w=-p*m*(.67*d-.0033*S),v=-p*m*(1.1*d-.041*b),M=-p*m*(1/12+.017*h*b-.33*d);return{Yvacc:.5*(-p*m*(1+.16*h*b-5.1*g))*l*f(s,3),Yracc:.5*w*l*f(s,4),Nvacc:.5*v*l*f(s,4),Nracc:.5*M*l*f(s,5),Yvdn:-(.145+2.25/u-.2*c),Yrdn:this.m/(.5*l*f(s,2)*a)-(.282+.1*c)+(.0086*c+.004)*u,Nvdn:.00484*u-(.222+.1*c),Nrdn:-(.0424-.03*c)-(.004*c-27e-5)*u}}),"hydroCoeff"),dn:w.prototype.memoized((function(){const t=this.ship.structure.hull.attributes.LOA;var e=.5*this.rho*Math.pow(t,2),i=e*t;return{Cl:e,Cll:i,Clll:i*t}}),"dn")})}getRes(t){let e=Math.pow;const i=Boolean(t.states.calculationParameters.speed)?t.states.calculationParameters.speed:10;t.hullRes.setSpeed(i);let s=t.hullRes.totalResistance.Rtadd/Math.pow(.5144447*i,2);return function(t){return s*e(t,2)*Math.sign(t)}}getPropResult(t){if(0===t)return{Fp:0,Pp:0,cons:0};var e,i=this.propellerInteraction.propulsion.Va,s=100*(this.floatState.LCB-(this.floatState.minXs+this.floatState.LWL/2))/this.floatState.LWL,a=Math.abs(i/(t*this.propeller.D)),o=this.propeller.beta1-this.propeller.beta2*a,h=this.propeller.gamma1-this.propeller.gamma2*a;1===this.propeller.noProps?e=.9922-.05908*this.propeller.AeAo+.07424*(this.floatState.Cp-.0225*s):2===this.propeller.noProps&&(e=.9737+.111*(this.floatState.Cp-.0225*s)-.06325*this.propeller.P/this.propeller.D);var n=o*this.rho*Math.pow(t,2)*Math.pow(this.propeller.D,4),r=h*this.rho*Math.pow(t,2)*Math.pow(this.propeller.D,5),l=Math.sign(t)*n*this.propeller.noProps*(1-this.resistanceState.t),c=2*Math.PI*Math.abs(r*t)*this.propeller.noProps*e;return{Fp:l,Pp:c,cons:this.getFuelCons(c)}}getFuelCons(t){function e(t,e){for(var i=0,s=[],a=0;a<t.engines.length;a++)s[a]=t.engines[a].MCR;"number"==typeof t.etag?e/=t.etas*t.etag:e/=t.etas;var o,h=s.reduce(((t,e)=>t+e),0),n=h-s[s.length-1],r=Array(s.length);if(e<=.8*n){var l=0;r.fill(0);for(var c=0;c<s.length;c++)if(e<=.8*(l+=s[c])){for(a=0;a<=c;a++)r[a]=e/l;break}}else.8*n<e&&e<=h?r.fill(e/h):e>h&&(console.error("Engines are overloaded. Power plant can't provide current required power."),r.fill(1));for(a=0;a<r.length;a++)r[a]>0&&(3===t.engines[a].polOrder?o=t.engines[a].a*Math.pow(r[a],3)+t.engines[a].b*Math.pow(r[a],2)+t.engines[a].c*r[a]+t.engines[a].d:2===t.engines[a].polOrder&&(o=t.engines[a].a*Math.pow(r[a],2)+t.engines[a].b*r[a]+t.engines[a].c),i+=o/1e3*r[a]*s[a]);return i}var i;return"object"==typeof this.powerPlant.auxiliary?(i=this.powerPlant.main.noSys*e(powerPlant.main,t/(1e3*this.powerPlant.main.noSys)),i+=e(this.powerPlant.auxiliary,this.auxPowerState.Paux/1e3)):i=e(this.powerPlant.main,t/1e3),i}}const C={linearFromArrays:function(t,s,a){let{index:o,mu:h}=e(t,a);return void 0===o||void 0===h?0:i(s[o],s[o+1],h)},bilinear:function(t,e,i,a,o,h,n,r,l,c){let[f,p,u,d]=s(t,e,i,a,o,h,n,r);return f+p*l+u*c+d*l*c},bisectionSearch:e};"undefined"!=typeof window&&(window.__VESSEL__?console.warn("WARNING: Multiple instances of Vessel.js being imported."):window.__VESSEL__="v0.14-alpha");export{a as BaseObject,h as DerivedObject,x as FuelConsumption,M as HullResistance,j as Manoeuver,O as Positioning,y as PropellerInteraction,S as Ship,d as ShipState,w as StateModule,m as WaveCreator,v as WaveMotion,L as downloadShip,C as f,b as loadShip};
